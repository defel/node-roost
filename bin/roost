#!/usr/bin/env node

// ---

var path = require('path');

// ---

var opt = require('node-getopt')
	.create([
		['r' , 'roost=ARG', 'Specify the root of a roost project or a roost manifest.'],
		['d' , 'dry', 'Dry run the roost manifest.'],
		['h' , 'help', 'Display this help.'],
	])
	.bindHelp()
	.parseSystem();
	
// ---

var lib = path.join(__dirname, '..', 'lib');
var manifest = require(path.join(lib, 'manifest.js'));
var plugins = require(path.join(lib, 'plugins.js'));
var targets = require(path.join(lib, 'targets.js'));
var engine = require(path.join(lib, 'engine.js'));

// --

var roostLocation;

try {
	roostLocation = manifest.locate(opt.options.roost);
} catch (e) {
	console.error(e.message);
	
	process.exit(2);
}

// --

var roostManifest;

try {
	roostManifest = manifest.load(roostLocation);
} catch (e) {
	console.error(e.message);
	
	process.exit(3);
}

// ---

var executionPlugins;

try {
	executionPlugins = plugins.obtain(roostManifest);
} catch (e) {
	console.error(e.message);
	
	process.exit(4);
}

// ---

var targetInstances;

try {
	targetInstances = targets.obtain(opt.argv.length ? opt.argv : ['local:']);
} catch (e) {
	console.error(e.message);
	
	process.exit(5);
}

// ---

if (targetInstances.length == 0) {
	console.error('no target specified');
	
	process.exit(6);
}

// ---

targetInstances.forEach(function (targetInstance) {
	try {
		engine.launch(roostManifest, executionPlugins, targetInstance);
	} catch (e) {
		console.error(e.message);
		
		process.exit(7);
	}
	
	try {
		targetInstance.ignite(opt.options.dry);
	} catch (e) {
		console.error(e.message);
		
		process.exit(8);
	}
});
